if (top_n) {
o <- "Others"
} else {
o <- "Rest of the world"
}
top_partners <- data %>%
filter(partner_iso != "WLD", year == year) %>%
group_by(partner_iso) %>%
tally(trade_value_usd, sort = T) %>%
top_n(top_n) %>%
pull(partner_iso)
if (include_others) {
others <- data %>%
filter(year == yr, !(partner_iso %in% top_partners), partner_iso != "WLD") %>%
group_by(trade_flow) %>%
summarise(trade_value_usd = sum(trade_value_usd)) %>%
mutate(partner_iso = o, partner = o)
toplot <- data %>%
filter(year == yr, partner_iso %in% top_partners) %>%
bind_rows(others) %>%
mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners, o)))
} else {
toplot <- data %>%
filter(year == yr, partner_iso %in% top_partners) %>%
mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners)))
}
toplot <- toplot %>%
ungroup() %>%
mutate(trade_value_usd_bn = billion(trade_value_usd))
p <- toplot %>%
group_by(partner_iso, trade_flow) %>%
mutate(label_pos = max(trade_value_usd_bn/2, 100)) %>%
ungroup() %>%
ggplot(aes(y = trade_value_usd_bn, x = trade_flow, fill = trade_flow)) +
geom_col() +
geom_text(aes(label = number(trade_value_usd_bn, big.mark = "'"), y = label_pos), size = 3) +
facet_wrap(~partner_iso_fac, dir = "h",
nrow = max(1, ceiling(sqrt(top_n)), na.rm = T),
# ncol = max(1, ceiling((top_n+include_others)/ceiling(sqrt(top_n))), na.rm = T)
) +
scale_fill_manual(values = c("#88be3f", "#02a7eb"))
if (include_flags) {
countries_annotate <- toplot %>%
select(partner_iso, partner) %>%
distinct() %>%
mutate(path = paste0("./flags/", str_replace_all(partner, " ", "_"), ".png"))
max_y <- max(toplot$trade_value_usd_bn, na.rm = T)
for (i in 1:top_n) {
if (!top_n) { next() }
data_annotate <- tibble(partner_iso_fac = factor(countries_annotate[i, "partner_iso"], levels = c(top_partners, o)),
trade_flow = "Export", trade_value_usd_bn = 1)
if (file.exists(countries_annotate[i, "path"])) {
img <- readPNG(countries_annotate[i, "path"])
p <- p +
annotation_custom2(rasterGrob(img, interpolate=TRUE),
ymax = max_y, ymin = max_y*0.8,
xmin = -1, data = data_annotate)
} else {
next()
}
}
}
p <- p +
labs(x = "", y = "",
title = title, subtitle = paste0("trade value in billion USD, year: ", yr),
caption = "Data: UN Comtrade") +
theme(legend.position = "none") #+
# theme_bw()
return(p)
}
trade_plot(us, top_n = 0, include_others = T, include_flags = T)
4*4
trade_plot(us, top_n = 16, include_others = F, include_flags = T)
trade_plot(us, top_n = 25, include_others = F, include_flags = T)
trade_plot(us, top_n = 24, include_others = T, include_flags = T)
us %>% filter(partner_iso == "CHN", year == 2018) %>% pull(trade_value_usd)
us %>% filter(partner_iso == "CHN", year == 2018, trade_flow == "Export") %>% pull(trade_value_usd)
us %>% filter(partner_iso == "CHN", year == 2018, trade_flow == "Import") %>% pull(trade_value_usd)
us %>% filter(partner_iso == "CHN", year == 2018, trade_flow == "Import") %>% pull(trade_value_usd) %>% billion() %>% number()
us %>% filter(partner_iso == "CHN", year == 2018, trade_flow == "Import") %>% pull(trade_value_usd) %>% billion() %>% number()
chim/im
chim <- us %>% filter(partner_iso == "CHN", year == 2018, trade_flow == "Import") %>% pull(trade_value_usd) %>% billion(); chim %>% number()
chim/im
chim/ (us %>% filter(year == 2018, partner_iso == "WLD, trade_flow = Import) %>% pull(trade_value_usd))
chim/ (us %>% filter(year == 2018, partner_iso == "WLD, trade_flow = Import) %>% pull(trade_value_usd))
chim/ (us %>% filter(year == 2018, partner_iso == "WLD, trade_flow == Import) %>% pull(trade_value_usd))
chim/ (us %>% filter(year == 2018, partner_iso == "WLD, trade_flow == "Import") %>% pull(trade_value_usd))
us %>% filter(year == 2018, partner_iso == "WLD, trade_flow == "Import") %>% pull(trade_value_usd)
us %>% filter(year == 2018, partner_iso == "WLD, trade_flow == "Import") %>% pull(trade_value_usd)
chim/ (us %>% filter(year == 2018, partner_iso == "WLD", trade_flow == "Import") %>% pull(trade_value_usd))
chim / (us %>% filter(year == 2018, partner_iso == "WLD", trade_flow == "Import") %>% pull(trade_value_usd) %>% billion() )
chim / (us %>% filter(year == 2018, partner_iso == "WLD", trade_flow == "Import") %>% pull(trade_value_usd) %>% billion()) %>% percent()
(chim / (us %>% filter(year == 2018, partner_iso == "WLD", trade_flow == "Import") %>% pull(trade_value_usd) %>% billion())) %>% percent()
chim <- us %>% filter(partner_iso == "CHN", year == 2018, trade_flow == "Export") %>% pull(trade_value_usd) %>% billion(); chex %>% number()
chex <- us %>% filter(partner_iso == "CHN", year == 2018, trade_flow == "Export") %>% pull(trade_value_usd) %>% billion(); chex %>% number()
(chex / (us %>% filter(year == 2018, partner_iso == "WLD", trade_flow == "Export") %>% pull(trade_value_usd) %>% billion())) %>% percent()
top_par
top_partners
top_5 <- us %>%
filter(partner_iso != "WLD", year == 2018) %>%
group_by(partner_iso) %>%
tally(trade_value_usd, sort = T) %>%
top_n(5) %>%
pull(partner_iso)
top_5
us %>%
filter(partner_iso %in% top_5, trade_flow == "Import") %>%
ggplot(aes(x = year, y = billion(trade_flow_usd))) +
geom_line()
us %>%
filter(partner_iso %in% top_5, trade_flow == "Import") %>%
ggplot(aes(x = year, y = billion(trade_value_usd))) +
geom_line()
us %>%
filter(partner_iso %in% top_5, trade_flow == "Import", color = partner) %>%
ggplot(aes(x = year, y = billion(trade_value_usd))) +
geom_line()
us %>%
filter(partner_iso %in% top_5, trade_flow == "Import") %>%
ggplot(aes(x = year, y = billion(trade_value_usd), color = partner_iso)) +
geom_line()
billion <- function(value) {
value/1000000000
}
# function similar to annotation_custom() but specifying data
annotation_custom2 <- function (grob, xmin = -Inf, xmax = Inf,
ymin = -Inf, ymax = Inf,
data) {
layer(data = data,
stat = StatIdentity,
position = PositionIdentity,
geom = ggplot2:::GeomCustomAnn,
inherit.aes = TRUE, params = list(grob = grob,
xmin = xmin, xmax = xmax,
ymin = ymin, ymax = ymax))
}
trade_plot <- function(data, yr = 2018, top_n = 8, include_others = T, include_flags = T, title = "USA import and exports") {
if (top_n) {
o <- "Others"
} else {
o <- "Rest of the world"
}
top_partners <- data %>%
filter(partner_iso != "WLD", year == year) %>%
group_by(partner_iso) %>%
tally(trade_value_usd, sort = T) %>%
top_n(top_n) %>%
pull(partner_iso)
if (include_others) {
others <- data %>%
filter(year == yr, !(partner_iso %in% top_partners), partner_iso != "WLD") %>%
group_by(trade_flow) %>%
summarise(trade_value_usd = sum(trade_value_usd)) %>%
mutate(partner_iso = o, partner = o)
toplot <- data %>%
filter(year == yr, partner_iso %in% top_partners) %>%
bind_rows(others) %>%
mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners, o)))
} else {
toplot <- data %>%
filter(year == yr, partner_iso %in% top_partners) %>%
mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners)))
}
toplot <- toplot %>%
ungroup() %>%
mutate(trade_value_usd_bn = billion(trade_value_usd)) %>%
group_by(trade_flow) %>%
mutate(share_of_total = trade_value_usd_bn/sum(trade_value_usd_bn))
p <- toplot %>%
group_by(partner_iso, trade_flow) %>%
mutate(label_pos = max(trade_value_usd_bn/2, 100)) %>%
ungroup() %>%
ggplot(aes(y = trade_value_usd_bn, x = trade_flow, fill = trade_flow)) +
geom_col() +
geom_text(aes(label = number(trade_value_usd_bn, big.mark = "'"), y = label_pos), size = 3) +
geom_label(aes(label = percent(share_of_total))) +
facet_wrap(~partner_iso_fac, dir = "h",
nrow = max(1, ceiling(sqrt(top_n)), na.rm = T),
# ncol = max(1, ceiling((top_n+include_others)/ceiling(sqrt(top_n))), na.rm = T)
) +
scale_fill_manual(values = c("#88be3f", "#02a7eb"))
if (include_flags) {
countries_annotate <- toplot %>%
select(partner_iso, partner) %>%
distinct() %>%
mutate(path = paste0("./flags/", str_replace_all(partner, " ", "_"), ".png"))
max_y <- max(toplot$trade_value_usd_bn, na.rm = T)
for (i in 1:top_n) {
if (!top_n) { next() }
data_annotate <- tibble(partner_iso_fac = factor(countries_annotate[i, "partner_iso"], levels = c(top_partners, o)),
trade_flow = "Export", trade_value_usd_bn = 1)
if (file.exists(countries_annotate[i, "path"])) {
img <- readPNG(countries_annotate[i, "path"])
p <- p +
annotation_custom2(rasterGrob(img, interpolate=TRUE),
ymax = max_y, ymin = max_y*0.8,
xmin = -1, data = data_annotate)
} else {
next()
}
}
}
p <- p +
labs(x = "", y = "",
title = title, subtitle = paste0("trade value in goods in billion USD, year: ", yr),
caption = "Data: UN Comtrade") +
theme(legend.position = "none") #+
# theme_bw()
return(p)
}
trade_plot(us, top_n = 24, include_others = T, include_flags = T)
data <- us
yr = 2018
top_n = 8
include_others = T
include_flags = T
title = "USA import and exports"
if (top_n) {
o <- "Others"
} else {
o <- "Rest of the world"
}
o
top_partners <- data %>%
filter(partner_iso != "WLD", year == year) %>%
group_by(partner_iso) %>%
tally(trade_value_usd, sort = T) %>%
top_n(top_n) %>%
pull(partner_iso)
top_partners
include_others
others <- data %>%
filter(year == yr, !(partner_iso %in% top_partners), partner_iso != "WLD") %>%
group_by(trade_flow) %>%
summarise(trade_value_usd = sum(trade_value_usd)) %>%
mutate(partner_iso = o, partner = o)
toplot <- data %>%
filter(year == yr, partner_iso %in% top_partners) %>%
bind_rows(others) %>%
mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners, o)))
toplot
toplot %>% as.tibble()
toplot <- toplot %>%
ungroup() %>%
mutate(trade_value_usd_bn = billion(trade_value_usd)) %>%
group_by(trade_flow) %>%
mutate(share_of_total = trade_value_usd_bn/sum(trade_value_usd_bn))
others <- data %>%
filter(year == yr, !(partner_iso %in% top_partners), partner_iso != "WLD") %>%
group_by(trade_flow) %>%
summarise(trade_value_usd = sum(trade_value_usd)) %>%
mutate(partner_iso = o, partner = o, year = yr)
toplot <- data %>%
filter(year == yr, partner_iso %in% top_partners) %>%
bind_rows(others) %>%
mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners, o)))
toplot
toplot %>% as.tibble()
toplot <- toplot %>%
ungroup() %>%
mutate(trade_value_usd_bn = billion(trade_value_usd)) %>%
group_by(trade_flow) %>%
mutate(share_of_total = trade_value_usd_bn/sum(trade_value_usd_bn))
toplot %>% as.tibble()
toplot %>% as.tibble() %>% select(trade_value_usd_bn, share_of_total, everything())
toplot %>% as.tibble() %>% select(trade_value_usd_bn, share_of_total, partner_iso, everything())
billion <- function(value) {
value/1000000000
}
# function similar to annotation_custom() but specifying data
annotation_custom2 <- function (grob, xmin = -Inf, xmax = Inf,
ymin = -Inf, ymax = Inf,
data) {
layer(data = data,
stat = StatIdentity,
position = PositionIdentity,
geom = ggplot2:::GeomCustomAnn,
inherit.aes = TRUE, params = list(grob = grob,
xmin = xmin, xmax = xmax,
ymin = ymin, ymax = ymax))
}
trade_plot <- function(data, yr = 2018, top_n = 8, include_others = T, include_flags = T, title = "USA import and exports") {
if (top_n) {
o <- "Others"
} else {
o <- "Rest of the world"
}
top_partners <- data %>%
filter(partner_iso != "WLD", year == year) %>%
group_by(partner_iso) %>%
tally(trade_value_usd, sort = T) %>%
top_n(top_n) %>%
pull(partner_iso)
if (include_others) {
others <- data %>%
filter(year == yr, !(partner_iso %in% top_partners), partner_iso != "WLD") %>%
group_by(trade_flow) %>%
summarise(trade_value_usd = sum(trade_value_usd)) %>%
mutate(partner_iso = o, partner = o, year = yr)
toplot <- data %>%
filter(year == yr, partner_iso %in% top_partners) %>%
bind_rows(others) %>%
mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners, o)))
} else {
toplot <- data %>%
filter(year == yr, partner_iso %in% top_partners) %>%
mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners)))
}
toplot <- toplot %>%
ungroup() %>%
mutate(trade_value_usd_bn = billion(trade_value_usd)) %>%
group_by(trade_flow) %>%
mutate(share_of_total = trade_value_usd_bn/sum(trade_value_usd_bn))
p <- toplot %>%
group_by(partner_iso, trade_flow) %>%
mutate(label_pos = max(trade_value_usd_bn/2, 100)) %>%
ungroup() %>%
ggplot(aes(y = trade_value_usd_bn, x = trade_flow, fill = trade_flow)) +
geom_col() +
geom_text(aes(label = number(trade_value_usd_bn, big.mark = "'"), y = label_pos), size = 3) +
# geom_label(aes(label = percent(share_of_total))) +
facet_wrap(~partner_iso_fac, dir = "h",
nrow = max(1, ceiling(sqrt(top_n)), na.rm = T),
# ncol = max(1, ceiling((top_n+include_others)/ceiling(sqrt(top_n))), na.rm = T)
) +
scale_fill_manual(values = c("#88be3f", "#02a7eb"))
if (include_flags) {
countries_annotate <- toplot %>%
select(partner_iso, partner) %>%
distinct() %>%
mutate(path = paste0("./flags/", str_replace_all(partner, " ", "_"), ".png"))
max_y <- max(toplot$trade_value_usd_bn, na.rm = T)
for (i in 1:top_n) {
if (!top_n) { next() }
data_annotate <- tibble(partner_iso_fac = factor(countries_annotate[i, "partner_iso"], levels = c(top_partners, o)),
trade_flow = "Export", trade_value_usd_bn = 1)
if (file.exists(countries_annotate[i, "path"])) {
img <- readPNG(countries_annotate[i, "path"])
p <- p +
annotation_custom2(rasterGrob(img, interpolate=TRUE),
ymax = max_y, ymin = max_y*0.8,
xmin = -1, data = data_annotate)
} else {
next()
}
}
}
p <- p +
labs(x = "", y = "",
title = title, subtitle = paste0("trade value in goods in billion USD, year: ", yr),
caption = "Data: UN Comtrade") +
theme(legend.position = "none") #+
# theme_bw()
return(p)
}
trade_plot(us, top_n = 0, include_others = T, include_flags = T)
trade_plot(us, top_n = 24, include_others = T, include_flags = T)
countries_annotate <- toplot %>%
select(partner_iso, partner) %>%
distinct() %>%
mutate(path = paste0("./flags/", str_replace_all(partner, " ", "_"), ".png"))
billion <- function(value) {
value/1000000000
}
# function similar to annotation_custom() but specifying data
annotation_custom2 <- function (grob, xmin = -Inf, xmax = Inf,
ymin = -Inf, ymax = Inf,
data) {
layer(data = data,
stat = StatIdentity,
position = PositionIdentity,
geom = ggplot2:::GeomCustomAnn,
inherit.aes = TRUE, params = list(grob = grob,
xmin = xmin, xmax = xmax,
ymin = ymin, ymax = ymax))
}
trade_plot <- function(data, yr = 2018, top_n = 8, include_others = T, include_flags = T, title = "USA import and exports") {
if (top_n) {
o <- "Others"
} else {
o <- "Rest of the world"
}
top_partners <- data %>%
filter(partner_iso != "WLD", year == year) %>%
group_by(partner_iso) %>%
tally(trade_value_usd, sort = T) %>%
top_n(top_n) %>%
pull(partner_iso)
if (include_others) {
others <- data %>%
filter(year == yr, !(partner_iso %in% top_partners), partner_iso != "WLD") %>%
group_by(trade_flow) %>%
summarise(trade_value_usd = sum(trade_value_usd)) %>%
mutate(partner_iso = o, partner = o, year = yr)
toplot <- data %>%
filter(year == yr, partner_iso %in% top_partners) %>%
bind_rows(others) %>%
mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners, o)))
} else {
toplot <- data %>%
filter(year == yr, partner_iso %in% top_partners) %>%
mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners)))
}
toplot <- toplot %>%
ungroup() %>%
mutate(trade_value_usd_bn = billion(trade_value_usd)) %>%
group_by(trade_flow) %>%
mutate(share_of_total = trade_value_usd_bn/sum(trade_value_usd_bn)) %>%
ungroup()
p <- toplot %>%
group_by(partner_iso, trade_flow) %>%
mutate(label_pos = max(trade_value_usd_bn/2, 100)) %>%
ungroup() %>%
ggplot(aes(y = trade_value_usd_bn, x = trade_flow, fill = trade_flow)) +
geom_col() +
geom_text(aes(label = number(trade_value_usd_bn, big.mark = "'"), y = label_pos), size = 3) +
# geom_label(aes(label = percent(share_of_total))) +
facet_wrap(~partner_iso_fac, dir = "h",
nrow = max(1, ceiling(sqrt(top_n)), na.rm = T),
# ncol = max(1, ceiling((top_n+include_others)/ceiling(sqrt(top_n))), na.rm = T)
) +
scale_fill_manual(values = c("#88be3f", "#02a7eb"))
if (include_flags) {
countries_annotate <- toplot %>%
select(partner_iso, partner) %>%
distinct() %>%
mutate(path = paste0("./flags/", str_replace_all(partner, " ", "_"), ".png"))
max_y <- max(toplot$trade_value_usd_bn, na.rm = T)
for (i in 1:top_n) {
if (!top_n) { next() }
data_annotate <- tibble(partner_iso_fac = factor(countries_annotate[i, "partner_iso"], levels = c(top_partners, o)),
trade_flow = "Export", trade_value_usd_bn = 1)
if (file.exists(countries_annotate[i, "path"])) {
img <- readPNG(countries_annotate[i, "path"])
p <- p +
annotation_custom2(rasterGrob(img, interpolate=TRUE),
ymax = max_y, ymin = max_y*0.8,
xmin = -1, data = data_annotate)
} else {
next()
}
}
}
p <- p +
labs(x = "", y = "",
title = title, subtitle = paste0("trade value in goods in billion USD, year: ", yr),
caption = "Data: UN Comtrade") +
theme(legend.position = "none") #+
# theme_bw()
return(p)
}
trade_plot(us, top_n = 24, include_others = T, include_flags = T)
top_partners <- data %>%
filter(partner_iso != "WLD", year == year) %>%
group_by(partner_iso) %>%
tally(trade_value_usd, sort = T) %>%
top_n(top_n) %>%
pull(partner_iso)
others <- data %>%
filter(year == yr, !(partner_iso %in% top_partners), partner_iso != "WLD") %>%
group_by(trade_flow) %>%
summarise(trade_value_usd = sum(trade_value_usd)) %>%
mutate(partner_iso = o, partner = o, year = yr)
toplot <- data %>%
filter(year == yr, partner_iso %in% top_partners) %>%
bind_rows(others) %>%
mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners, o)))
toplot <- toplot %>%
ungroup() %>%
mutate(trade_value_usd_bn = billion(trade_value_usd)) %>%
group_by(trade_flow) %>%
mutate(share_of_total = trade_value_usd_bn/sum(trade_value_usd_bn)) %>%
ungroup()
countries_annotate <- toplot %>%
select(partner_iso, partner) %>%
distinct() %>%
mutate(path = paste0("./flags/", str_replace_all(partner, " ", "_"), ".png"))
countries_annotate
i = 8
data_annotate <- tibble(partner_iso_fac = factor(countries_annotate[i, "partner_iso"], levels = c(top_partners, o)),
trade_flow = "Export", trade_value_usd_bn = 1)
data_annotate
if (file.exists(countries_annotate[i, "path"])) {
img <- readPNG(countries_annotate[i, "path"])
p <- p +
annotation_custom2(rasterGrob(img, interpolate=TRUE),
ymax = max_y, ymin = max_y*0.8,
xmin = -1, data = data_annotate)
} else {
next()
}
countries_annotate[i, "path"]
if (file.exists(countries_annotate[i, "path"] %>% pull())) {
img <- readPNG(countries_annotate[i, "path"])
p <- p +
annotation_custom2(rasterGrob(img, interpolate=TRUE),
ymax = max_y, ymin = max_y*0.8,
xmin = -1, data = data_annotate)
} else {
next()
}
countries_annotate[i, "path"] %>% pull()
if (file.exists((countries_annotate[i, "path"] %>% pull()))) {
img <- readPNG(countries_annotate[i, "path"])
p <- p +
annotation_custom2(rasterGrob(img, interpolate=TRUE),
ymax = max_y, ymin = max_y*0.8,
xmin = -1, data = data_annotate)
} else {
next()
}
file.exists("./flags/United_Kingdom.png")
