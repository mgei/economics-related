---
title: "International Trade"
author: "Martin Geissmann"
date: "5/21/2019"
output: html_document
---

# Let's have a look at imports and exports 

## Loading R packages

```{r packages, echo=F}
library(tidyverse)
library(comtradr)
library(visNetwork)
library(grid)
library(png)
library(RCurl)

library(scales)

```

[UN Comtrade](https://comtrade.un.org/) is a repository of official international trade statistics and relevant analytical tables. It allows to view and download detailed global trade data, i.e. imports and exports of all goods or even of specific services or goods (say tomatoes). [comtradr](https://github.com/ropensci/comtradr) is a R package and a collection of functions for interacting with the UN Comtrade API.

## How to use comtradr

```{r comtradedata, echo=F, warning=F, message=F}

# q %>% saveRDS("data/sample1.RDS")

q <- readRDS("data/sample1.RDS")

us <- readRDS("data/us.RDS")

ch <- readRDS("data/ch.RDS")

com <- readRDS("data/com.RDS")

```

```{r sample1, eval=F}
q <- ct_search(reporters = "USA", 
               partners = c("Germany", "France", "Japan", "Mexico"), 
               trade_direction = "imports")

```

There are `ct_search()` has more arguments:

* reporters: Reporting country, can be "All" (required)
    * can use `ct_country_lookup()` to look up the name of a country, e.g. `ct_country_lookup("russia")`
* partners: Partner country, can be "All (required)
* trade_direction: "imports", "exports", "re_imports", "re_exports". Default value is "all"
* freq: "annual" or "monthly". Default value is "annual".
* start_date: "yyyy" if freq="annual" or "yyyy-mm" if freq="monthly", can be "all" (default)
* end_date: same	
* commod_codes: character vector of commodity codes, or "TOTAL" (default)
    * use `ct_commodity_lookup()` to look up codes, e.g. `tomatoes <- ct_commodity_lookup("tomato")`
* max_rec: max. number of records, 50'000 without API token, 250'000 with (see also `ct_register_token()`)
* type: "goods" or "services". Default value is "goods".
* url: not needed

Without API token you got 100 requests per day, check with `ct_get_remaining_hourly_queries()`.

```{r sample2}
q %>% glimpse()

q %>% 
  as_tibble() %>% 
  filter(reporter == "USA", partner %in% c("Germany", "Mexico")) %>% 
  select(trade_value_usd, reporter, partner, everything()) %>% 
  ggplot(aes(x = year, y = trade_value_usd/1000000000, fill = partner)) +
  geom_col(alpha = 0.6, position = "dodge") +
  scale_y_continuous(labels = scales::number) +
  scale_x_continuous(breaks = seq(1990, 2018, 2)) +
  labs(title = "US imports from Germany and from Mexico", y = "billion USD") +
  theme_bw()
```

# US trading partners

## UN Comtrade ata

```{r data1, eval=F}

us1 <- ct_search(reporters = "USA", 
                 partners = "All", 
                 trade_direction = c("imports", "exports"),
                 freq = "annual",
                 start_date = (2018-4),
                 end_date = 2018)

us2 <- ct_search(reporters = "USA", 
                 partners = "All", 
                 trade_direction = c("imports", "exports"),
                 freq = "annual",
                 start_date = (2013-4),
                 end_date = 2013)

us3 <- ct_search(reporters = "USA", 
                 partners = "All", 
                 trade_direction = c("imports", "exports"),
                 freq = "annual",
                 start_date = (2009-4),
                 end_date = 2009)

us4 <- ct_search(reporters = "USA", 
                 partners = "All", 
                 trade_direction = c("imports", "exports"),
                 freq = "annual",
                 start_date = (2004-4),
                 end_date = 2004)

us5 <- ct_search(reporters = "USA", 
                 partners = "All", 
                 trade_direction = c("imports", "exports"),
                 freq = "annual",
                 start_date = (2000-4),
                 end_date = 2000)

us6 <- ct_search(reporters = "USA", 
                 partners = "All", 
                 trade_direction = c("imports", "exports"),
                 freq = "annual",
                 start_date = (1996-4),
                 end_date = 1996)

us <- bind_rows(us1, us2, us3, us4, us5, us6) %>% distinct()

us %>% saveRDS("data/us.RDS")

```

```{r graphdata}

# from to value

data <- us %>% filter(year == 2018, partner != "World")

edges <- bind_rows(
  # exports
  data %>% 
    filter(trade_flow == "Export") %>% 
    select(from = reporter, to = partner, value = trade_value_usd) %>% 
    arrange(desc(value)),
  
  # imports
  data %>% 
    filter(trade_flow == "Import") %>% 
    select(from = partner, to = reporter, value = trade_value_usd) %>% 
    arrange(desc(value))
)

cutoff <- 38000000000

nodes <- bind_rows(
  edges %>% 
    filter(value >= cutoff) %>% 
    select(id = from),
  edges %>% 
    filter(value >= cutoff) %>% 
    select(id = to)
) %>% 
  unique() %>% 
  left_join(data %>% filter(year == 2018) %>% select(id = partner, label = partner_iso) %>% unique()) %>% 
  mutate(shape = "circularImage", image = paste0("./flags/", id, ".png"))
  
visNetwork(nodes, edges, width = "100%") %>% 
  visEdges(arrows = "from")
  

```

```{r plotfunction}

billion <- function(value) {
  value/1000000000
}

# function similar to annotation_custom() but specifying data
annotation_custom2 <- function (grob, xmin = -Inf, xmax = Inf, 
                            ymin = -Inf, ymax = Inf, 
                            data) {
  layer(data = data, 
        stat = StatIdentity, 
        position = PositionIdentity,
        geom = ggplot2:::GeomCustomAnn,
        inherit.aes = TRUE, params = list(grob = grob, 
                                          xmin = xmin, xmax = xmax, 
                                          ymin = ymin, ymax = ymax))
}

trade_plot <- function(data, yr = 2018, top_n = 8, include_others = T, include_flags = T, title = "USA import and exports") {
  top_partners <- data %>% 
    filter(partner_iso != "WLD", !is.na(partner_iso), year == year) %>% 
    group_by(partner_iso) %>% 
    tally(trade_value_usd, sort = T) %>% 
    top_n(top_n) %>% 
    pull(partner_iso)
  
  if (include_others) {
    others <- data %>% 
      filter(year == yr, !(partner_iso %in% top_partners)) %>% 
      group_by(trade_flow) %>% 
      summarise(trade_value_usd = sum(trade_value_usd)) %>% 
      mutate(partner_iso = "Others", partner = "Others")
    
    # if (length(top_partners)) {
          toplot <- data %>% 
            filter(year == yr, partner_iso %in% top_partners) %>% 
            bind_rows(others) %>% 
            mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners, "Others")))
    # }
    # else {
    #   toplot <- others
    # }

  } else {
    toplot <- data %>% 
      filter(year == yr, partner_iso %in% top_partners) %>% 
      mutate(partner_iso_fac = factor(partner_iso, levels = c(top_partners)))
  }
  
  toplot <- toplot %>% 
    ungroup() %>% 
    mutate(trade_value_usd_bn = billion(trade_value_usd))
  
  p <- toplot %>% 
    group_by(partner_iso, trade_flow) %>% 
    mutate(label_pos = max(trade_value_usd_bn/2, 100)) %>%
    ungroup() %>% 
    ggplot(aes(y = trade_value_usd_bn, x = trade_flow, fill = trade_flow)) +
    geom_col() +
    geom_text(aes(label = round(trade_value_usd_bn, digits = 1), y = label_pos), size = 3) +
    facet_wrap(~partner_iso_fac, dir = "h", 
               nrow = max(1, ceiling(sqrt(top_n)), na.rm = T), 
               # ncol = max(1, ceiling((top_n+include_others)/ceiling(sqrt(top_n))), na.rm = T)
               ) +
    scale_fill_manual(values = c("#88be3f", "#02a7eb"))
  
  if (include_flags) {
    countries_annotate <- toplot %>% 
      select(partner_iso, partner) %>% 
      distinct() %>% 
      mutate(path = paste0("./flags/", str_replace_all(partner, " ", "_"), ".png"))
    
    max_y <- max(toplot$trade_value_usd_bn, na.rm = T)
    
    for (i in 1:top_n) {
      if (!top_n) { next() }
      data_annotate <- tibble(partner_iso_fac = factor(countries_annotate[i, "partner_iso"], levels = c(top_partners, "Others")), 
                              trade_flow = "Export", trade_value_usd_bn = 1)
      if (file.exists(countries_annotate[i, "path"])) {
        img <- readPNG(countries_annotate[i, "path"])
        
        p <- p + 
          annotation_custom2(rasterGrob(img, interpolate=TRUE), 
                             ymax = max_y, ymin = max_y*0.8, 
                             xmin = -1, data = data_annotate)
      } else {
          next()
        }
    }
  }
  p <- p + 
    labs(x = "", y = "",
         title = title, subtitle = paste0("trade value in billion USD, year: ", yr),
         caption = "Data: UN Comtrade") +
    theme(legend.position = "none") #+
    # theme_bw()
  
  return(p)
}

```

```{r tradeplot, out.height=6, out.width=6}

trade_plot(us, top_n = 9, include_others = F, include_flags = T)

```

# China trading partners

```{r data2, eval=F}

ch1 <- ct_search(reporters = "China", 
                 partners = "All", 
                 trade_direction = c("imports", "exports"),
                 freq = "annual",
                 start_date = (2018-4),
                 end_date = 2018)

ch2 <- ct_search(reporters = "China", 
                 partners = "All", 
                 trade_direction = c("imports", "exports"),
                 freq = "annual",
                 start_date = (2013-4),
                 end_date = 2013)

ch3 <- ct_search(reporters = "China", 
                 partners = "All", 
                 trade_direction = c("imports", "exports"),
                 freq = "annual",
                 start_date = (2009-4),
                 end_date = 2009)

ch4 <- ct_search(reporters = "China", 
                 partners = "All", 
                 trade_direction = c("imports", "exports"),
                 freq = "annual",
                 start_date = (2004-4),
                 end_date = 2004)

ch5 <- ct_search(reporters = "China", 
                 partners = "All", 
                 trade_direction = c("imports", "exports"),
                 freq = "annual",
                 start_date = (2000-4),
                 end_date = 2000)

ch6 <- ct_search(reporters = "China", 
                 partners = "All", 
                 trade_direction = c("imports", "exports"),
                 freq = "annual",
                 start_date = (1996-4),
                 end_date = 1996)

ch <- bind_rows(ch1, ch2, ch3, ch4, ch5, ch6) %>% distinct()

ch %>% saveRDS("data/ch.RDS")

```

```{r tradeplot2, out.height=6, out.width=6}

trade_plot(ch, yr = 2017, top_n = 8, include_others = T, include_flags = T, title = "China imports and exports")

```

# Development over time

```{r dev1}

data <- us %>% distinct() %>% 
  filter(partner_iso != "WLD") %>% 
  mutate(trade_value_usd_bn = billion(trade_value_usd)) %>% 
  group_by(trade_flow, year) %>% 
  summarise(trade_value_usd_bn = sum(trade_value_usd_bn, na.rm = T))

data %>% 
  ggplot(aes(x = year, y = trade_value_usd_bn, color = trade_flow, fill = trade_flow)) +
  geom_area(alpha = 0.3, position = "identity") +
  geom_point()

```

# Dependency and diversification

```{r dev1}

# Lorenzkurve
curvedata <- us %>% as.tibble() %>%
  filter(partner_iso != "WLD", year == 2018) %>% 
  mutate(trade_value_usd_bn = billion(trade_value_usd)) %>%
  group_by(trade_flow) %>% 
  # summarise(trade_value_usd_bn = sum(trade_value_usd_bn, na.rm = T)) %>% 
  arrange(trade_flow, trade_value_usd_bn) %>% 
  mutate(cumsharePartner = row_number()/n(),
         nPartner = n()-row_number(),
         sumtrade_value_usd_bn = sum(trade_value_usd_bn),
         sharetrade_value_usd_bn = trade_value_usd_bn/sum(trade_value_usd_bn),
         cumsharetrade_value_usd_bn = cumsum(sharetrade_value_usd_bn)) %>% 
  ungroup()

labeldata <- curvedata %>% 
  group_by(year) %>% 
  filter(min((cumsharetrade_value_usd_bn - 0.5)^2) == ((cumsharetrade_value_usd_bn - 0.5)^2) | 
         min((cumsharePartner - 0.5)^2) == ((cumsharePartner - 0.5)^2)) %>% 
  mutate(text = paste(percent(cumsharePartner), "or partners make up", percent(cumsharetrade_value_usd_bn), "trade")) %>% 
  ungroup()
  

curvedata %>% filter(year %in% 2016:2018) %>% 
  ggplot(aes(x = cumsharePartner, y = cumsharetrade_value_usd_bn, color = factor(year), group = year)) +
  geom_line(linetype = 2, size = 1) +
  geom_vline(data = labeldata %>% filter(year == 2018), aes(xintercept = cumsharePartner), alpha = 0.1) +
  geom_hline(data = labeldata %>% filter(year == 2018), aes(yintercept = cumsharetrade_value_usd_bn), alpha = 0.1) +
  geom_segment(data = labeldata %>% filter(year == 2018), aes(x = cumsharePartner, xend=cumsharePartner, y = cumsharetrade_value_usd_bn, yend=0), 
               color = "#cc0000") +
  geom_segment(data = labeldata %>% filter(year == 2018), aes(y = cumsharetrade_value_usd_bn, yend=cumsharetrade_value_usd_bn, x = cumsharePartner, xend=0), 
               color = "#cc0000") +
  geom_text(data = labeldata %>% filter(year == 2018), aes(label = text, x = cumsharePartner/2, y = cumsharetrade_value_usd_bn), nudge_y = 0.02, 
               color = "#cc0000") +
  scale_x_continuous(breaks = seq(0,1,0.1), labels = scales::percent, expand=c(0, 0)) +
  scale_y_continuous(breaks = seq(0,1,0.1), labels = scales::percent, expand=c(0, 0)) +
  labs(x = "Kundenanteil kumulativ", y = "Umsatzanteil kumulativ",
       color = "Jahr") +
  theme_bw() 

```

# A look at the goods

```{r whatgoods, eval = F}

com1 <- tibble()

for (i in 0:4) {
  codes <- c(1:20) + i*20
  
  com1 <- com1 %>% 
    bind_rows(ct_search(reporters = "USA", 
                        partners = "China", 
                        start_date = "2018",
                        end_date = "2018",
                        trade_direction = c("imports", "exports"),
                        commod_codes = str_pad(codes, 2, "left", "0")))
  
  print("sleep 10 secs")
  Sys.sleep(10)
}

com %>% saveRDS("data/com.RDS")

```

```{r whatgoods2}

top_com <- com %>% 
  group_by(commodity) %>% 
  tally(trade_value_usd, sort = T) %>% 
  top_n(8) %>% 
  pull(commodity)
  

com %>% 
  filter(commodity %in% top_com) %>% 
  select(trade_flow, trade_value_usd, commodity) %>% 
  arrange(-trade_value_usd) %>% 
  ggplot(aes(y = trade_value_usd, x = trade_flow)) +
  geom_col() +
  facet_wrap(~commodity, ncol = 2)


```